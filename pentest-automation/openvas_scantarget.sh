#!/bin/bash

RESDIR="Raw/OpenVAS"
mkdir -p $RESDIR

while [[ $# > 1 ]]
do
key="$1"

case $key in
    --client)
    OV_CLIENTNAME="$2"
    shift # past argument
    ;;
    --username)
    OV_USERNAME="$2"
    shift # past argument
    ;;
    --password)
    OV_PASSWORD="$2"
    shift # past argument
    ;;
    --target)
    OV_SCANTARGET="$2"
    shift # past argument
    ;;
    --scantype)
    OV_TYPE="$2"
    shift # past argument
    ;;
    --host)
    OV_HOST="$2"
    shift # past argument
    ;;
    --format)
    OV_FORMAT="$2"
    shift # past argument
    ;;
    *)
            # unknown option
    ;;
esac
shift # past argument or value
done

function usage
{
	echo "Usage: $0"
	echo "	--username	: Username"
	echo "	--password	: Password"
	echo "	--host		: Host"
	echo "	--client	: Clientname"
	echo "	--target	: Target"
	echo "	--scantype	: Scan type (see omp -g)"
	echo "	--format	: Report format (see omp -F)"
	echo ""
	echo "Example: $0 --username admin --password password --host localhost --client clientname --scantype \"Full and fast\" --target localhost --format txt"
	exit 1
}

if [ -z "$OV_USERNAME" ]
	then
		echo "No username (-u) given."
		usage
		exit 1
fi
if [ -z "$OV_PASSWORD" ]
	then
		echo "No password (-p)  given."
		usage
		exit 1
fi
if [ -z "$OV_HOST" ]
	then
		echo "No host (-h) given."
		usage
		exit 1
fi
if [ -z "$OV_SCANTARGET" ]
	then
		echo "No scan target (-t) given."
		usage
		exit 1
fi
if [ -z "$OV_TYPE" ]
	then
		echo "No scan type (-s) given."
		usage
		exit 1
fi
if [ -z "$OV_CLIENTNAME" ]
	then
		echo "No clientname (-c) given."
		usage
		exit 1
fi
if [ -z "$OV_FORMAT" ]
	then
		echo "No report format (-f) given."
		usage
		exit 1
fi

SCANOV_TYPE=`omp -w $OV_PASSWORD -u $OV_USERNAME -h $OV_HOST -n $OV_SCANTARGET -g | grep -i "$OV_TYPE" | head -n 1 | awk '{print($1)}'`
REPORTOV_FORMAT=`omp -w $OV_PASSWORD -u $OV_USERNAME -h $OV_HOST -n $OV_SCANTARGET -F | grep -i "$OV_FORMAT" | head -n 1 | awk '{print($1)}'`

echo "Creating host entry for $OV_SCANTARGET"
omp -w $OV_PASSWORD -u $OV_USERNAME -h $OV_HOST --xml="<create_target><name>$OV_SCANTARGET</name><hosts>$OV_SCANTARGET</hosts></create_target>"
SCANUUID=`omp -w $OV_PASSWORD -u $OV_USERNAME -h $OV_HOST -n $OV_SCANTARGET -T | grep -i $OV_SCANTARGET | awk '{print($1)}' | head -n 1`
echo "Creating task."
TASK_UUID=`omp -w $OV_PASSWORD -u $OV_USERNAME -h $OV_HOST --name "$OV_SCANTARGET" --create-task --target "$SCANUUID" --config "$SCANOV_TYPE"`
echo "Starting task."
REPORT_UUID=`omp -w $OV_PASSWORD -u $OV_USERNAME -h $OV_HOST --start-task $TASK_UUID`
echo "Waiting to finish."
DONE="Not done"
while [ "$DONE" != "Done" ]
do
	DONE=$(omp -w $OV_PASSWORD -u $OV_USERNAME -h $OV_HOST --get-tasks $TASK_UUID | head -n 1 | awk '{print($2)}')
	sleep 10
done
echo "Generating report in $OV_FORMAT format.";
omp -i -w $OV_PASSWORD -u $OV_USERNAME -h $OV_HOST --get-report $REPORT_UUID --format $REPORTOV_FORMAT >> $RESDIR/$OV_CLIENTNAME-$OV_USERNAME-$OV_SCANTARGET-$REPORT_UUID.$OV_FORMAT
echo "Report generated."
